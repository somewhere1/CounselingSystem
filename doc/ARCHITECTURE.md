# 系统架构文档

## 整体架构

心理咨询系统采用模块化设计，主要包含以下核心组件：

```
┌─────────────────────────────────────────────────────────────┐
│                    用户接口层                                │
├─────────────────────────────────────────────────────────────┤
│                    应用层                                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │ 主应用模块   │ │ 会话管理     │ │ 推理引擎     │         │
│  │ main.py     │ │ agents.py   │ │reasoning_   │         │
│  │             │ │             │ │ engine.py   │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    服务层                                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │ LLM客户端    │ │ 对话管理     │ │ 提示词管理   │         │
│  │llm_client.py│ │dialogue_    │ │ prompts.py  │         │
│  │             │ │manager.py   │ │             │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    数据层                                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │ 文件工具     │ │ 配置管理     │ │ 数据提取     │         │
│  │file_utils.py│ │ config.py   │ │ utils/      │         │
│  │             │ │             │ │             │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块详解

### 1. 主应用模块 (main.py)

**职责**: 系统入口，协调各模块工作

**核心类**: `CounselingSystemApp`

**主要功能**:
- 系统初始化和配置
- 会话流程控制
- 批量处理管理
- 结果保存和统计

**关键方法**:
```python
class CounselingSystemApp:
    def run_single_session()      # 运行单个会话
    def process_patient_folder()  # 串行批量处理
    def process_patient_folder_concurrent()  # 并发批量处理
    def validate_system()         # 系统验证
    def get_system_status()       # 获取系统状态
```

### 2. 智能体模块 (agents.py)

**职责**: 管理对话参与者和会话流程

**核心类**: 
- `BaseAgent`: 智能体基类
- `PatientAgent`: 患者智能体
- `CounselorAgent`: 咨询师智能体
- `ConversationSession`: 会话管理器

**智能体架构**:
```
BaseAgent (抽象基类)
├── PatientAgent (患者智能体)
│   ├── 生成患者回复
│   └── 模拟患者行为
└── CounselorAgent (咨询师智能体)
    ├── 生成咨询师回复
    ├── 推理评估
    └── 回复优化
```

### 3. 推理引擎 (reasoning_engine.py)

**职责**: 实现R1推理机制，优化咨询师回复

**核心功能**:
- 回复质量评估
- 多轮推理优化
- 修改建议生成
- 推理历史记录

**推理流程**:
```
原始回复 → 质量评估 → 推理分析 → 修改建议 → 优化回复
    ↓         ↓         ↓         ↓         ↓
  生成回复   评估质量   分析问题   生成建议   应用修改
```

### 4. LLM客户端 (llm_client.py)

**职责**: 管理多种AI模型的连接和调用

**支持的模型**:
- 智谱AI (ZhipuAI)
- 通义千问 (Qwen)
- 月之暗面 (Moonshot)
- OpenAI (通过代理)

**架构特点**:
- 多模型支持
- 自动故障转移
- 连接池管理
- 重试机制

### 5. 对话管理 (dialogue_manager.py)

**职责**: 管理对话流程和状态

**核心功能**:
- 对话历史管理
- 对话模式控制
- 会话状态跟踪
- 对话结束判断

**对话模式**:
- `PATIENT_FIRST`: 患者先发言
- `DOCTOR_FIRST`: 咨询师先发言

### 6. 文件工具 (file_utils.py)

**职责**: 文件操作和数据持久化

**核心类**:
- `FileManager`: 文件操作管理
- `SessionDataManager`: 会话数据管理
- `ProcessingLog`: 处理日志管理
- `BackupManager`: 备份管理

**文件组织结构**:
```
dialogue_files/     - 对话历史文件
reasoning_files/    - 推理过程文件
summary_files/      - 会话摘要文件
modification_files/ - 修改历史文件
original_files/     - 原始对话文件
```

### 7. 配置管理 (config.py)

**职责**: 集中管理系统配置

**配置分类**:
- 系统配置 (SystemConfig)
- 模型配置 (ModelConfig)
- API配置 (APIConfig)
- 路径配置 (PathConfig)

## 数据流

### 1. 单个会话数据流

```
患者信息 → 会话初始化 → 对话循环 → 推理评估 → 结果保存
    ↓           ↓           ↓           ↓           ↓
  输入数据    创建会话    生成回复    优化回复    保存文件
```

### 2. 批量处理数据流

```
患者档案 → 并发处理 → 会话执行 → 结果收集 → 统计报告
    ↓         ↓         ↓         ↓         ↓
  文件列表   线程池    会话管理   结果汇总   输出报告
```

### 3. 推理评估数据流

```
原始回复 → 质量评估 → 问题分析 → 修改建议 → 优化回复
    ↓         ↓         ↓         ↓         ↓
  咨询师回复  评估标准   推理分析   建议生成   最终回复
```

## 并发架构

### 线程池设计

```python
# 并发处理架构
ThreadPoolExecutor(max_workers=3)
├── Worker 1: 处理 patient_001.txt
├── Worker 2: 处理 patient_002.txt
└── Worker 3: 处理 patient_003.txt
```

### 线程安全机制

- **文件锁**: 使用 `threading.Lock()` 保护文件操作
- **状态管理**: 线程安全的状态跟踪
- **错误隔离**: 单个线程错误不影响其他线程

### 性能优化

- **连接池**: 复用LLM客户端连接
- **内存管理**: 及时释放不需要的数据
- **批处理**: 批量处理提高效率

## 错误处理架构

### 分层错误处理

```
应用层错误处理
├── 会话级错误处理
├── 文件级错误处理
└── 网络级错误处理
```

### 错误恢复机制

- **自动重试**: API调用失败时自动重试
- **故障转移**: 主模型失败时切换到备用模型
- **断点续传**: 支持中断后继续处理

## 扩展性设计

### 1. 模块化设计

每个模块职责单一，便于扩展和维护：

```
核心模块 (Core)
├── 会话管理 (Session Management)
├── 推理引擎 (Reasoning Engine)
└── 文件管理 (File Management)

扩展模块 (Extensions)
├── 新AI模型支持
├── 新的推理策略
└── 新的文件格式
```

### 2. 插件化架构

支持通过插件扩展功能：

```python
# 插件接口示例
class ReasoningPlugin:
    def evaluate_response(self, response: str) -> float:
        pass
    
    def suggest_improvements(self, response: str) -> List[str]:
        pass
```

### 3. 配置驱动

通过配置文件控制系统行为：

```python
# 配置示例
class SystemConfig:
    MAX_DIALOGUE_LENGTH = 70
    MAX_MODIFICATION_ATTEMPTS = 3
    ENABLE_CONCURRENT_PROCESSING = True
    MAX_WORKERS = 3
```

## 安全考虑

### 1. 数据安全

- **API密钥保护**: 使用环境变量存储敏感信息
- **数据加密**: 敏感数据加密存储
- **访问控制**: 限制文件访问权限

### 2. 隐私保护

- **数据脱敏**: 移除个人敏感信息
- **匿名化**: 使用匿名标识符
- **数据最小化**: 只收集必要数据

### 3. 系统安全

- **输入验证**: 验证所有输入数据
- **错误处理**: 避免信息泄露
- **日志安全**: 保护日志中的敏感信息

## 性能监控

### 1. 性能指标

- **处理速度**: 每秒处理的患者数量
- **响应时间**: API调用的平均响应时间
- **资源使用**: CPU、内存、网络使用情况

### 2. 监控机制

```python
# 性能监控示例
def monitor_performance():
    cpu_percent = psutil.cpu_percent()
    memory_percent = psutil.virtual_memory().percent
    return {
        "cpu_usage": cpu_percent,
        "memory_usage": memory_percent
    }
```

## 部署架构

### 1. 单机部署

适用于小规模使用：

```
应用服务器
├── Python环境
├── 配置文件
├── 数据文件
└── 日志文件
```

### 2. 分布式部署

适用于大规模使用：

```
负载均衡器
├── 应用服务器 1
├── 应用服务器 2
└── 应用服务器 3

共享存储
├── 患者档案
├── 会话结果
└── 日志文件
```

## 未来扩展

### 1. 功能扩展

- **多语言支持**: 支持多种语言的心理咨询
- **情感分析**: 集成情感分析功能
- **个性化**: 基于用户历史的个性化咨询

### 2. 技术扩展

- **微服务架构**: 拆分为多个微服务
- **容器化部署**: 使用Docker容器化
- **云原生**: 支持Kubernetes部署

### 3. 集成扩展

- **数据库集成**: 集成关系型数据库
- **消息队列**: 使用消息队列处理异步任务
- **监控系统**: 集成专业的监控系统

